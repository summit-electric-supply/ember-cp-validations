<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>addon/validators/base.js - Ember CP Validations</title>
    <meta name="description" content="Ember computed property based validations">
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="stylesheet" href="../assets/css/custom.css">
    <link rel="stylesheet" href="../assets/vendor/bootstrap/css/bootstrap.css">
    <link rel="stylesheet" href="../assets/vendor/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="../assets/css/theme.css">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,500,600,700' rel='stylesheet' type='text/css'>
    

</head>
<body>
    <nav class="navbar navbar-default">
      <div class="container-fluid">
        <div class="navbar-header">
          <a href="../" class="navbar-brand">
              <img src="../assets/img/ember-logo.png" alt="enterprise logo">
            <span>CP Validations</span>
          </a>
        </div>

        <div class="collapse navbar-collapse" id="nav">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="https://github.com/summit-electric-supply/ember-cp-validations" class="fa fa-github github"></a></li>
          </ul>
        </div>
      </div>
    </nav>
    <div id="main-wrapper" class="row">
        <div id="content-wrapper">
            <ol class="panel-group" id="sidebar" role="tablist" aria-multiselectable="true">
                <li class="panel panel-default">
                    <div class="panel-heading" role="tab" id="sidebar-search-heading">
                        <h4 class="panel-title">
                      <a role="button" data-toggle="collapse" href="#sidebar-search" aria-expanded="true" aria-controls="collapseOne">
                        Search
                      </a>
                    </h4>
                    </div>
                    <div id="sidebar-search" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="sidebar-search-heading">
                        <div class="panel-body">
                            <div id="api-tabview-filter">
                                <input type="search" id="api-filter" placeholder="Search...">
                            </div>
                        </div>
                    </div>
                </li>
                    <li class="panel panel-default">
                        <div class="panel-heading" role="tab" id="sidebar-version-heading">
                            <h4 class="panel-title">
                                <a role="button" href="https://github.com/summit-electric-supply/ember-cp-validations/commits/v4.1.0-beta.1" target="_blank">
                                  Tag: v4.1.0-beta.1
                                </a>
                            </h4>
                        </div>
                    </li>
                <li class="panel panel-default">
                    <div class="panel-heading" role="tab" id="sidebar-modules-heading">
                        <h4 class="panel-title">
                    <a role="button" data-toggle="collapse" href="#sidebar-modules" aria-expanded="true" aria-controls="collapseOne">
                      Modules
                    </a>
                  </h4>
                    </div>
                    <div id="sidebar-modules" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="sidebar-modules-heading">
                        <div class="panel-body">
                                <ol>
                                        <li>
                                            <a href="../modules/Usage.html">Usage</a>
                                                    <li class="sub"><a href="../modules/Basic.html">Basic</a></li>
                                                    <li class="sub"><a href="../modules/Advanced.html">Advanced</a></li>
                                                    <li class="sub"><a href="../modules/I18n Solutions.html">I18n Solutions</a></li>
                                        </li>
                                        <li>
                                            <a href="../modules/Validations.html">Validations</a>
                                                    <li class="sub"><a href="../modules/Accessing Validations.html">Accessing Validations</a></li>
                                        </li>
                                        <li>
                                            <a href="../modules/Validators.html">Validators</a>
                                                    <li class="sub"><a href="../modules/Common Options.html">Common Options</a></li>
                                        </li>
                                </ol>
                        </div>
                    </div>
                </li>
            
                <li class="panel panel-default">
                    <div class="panel-heading" role="tab" id="sidebar-classes-heading">
                        <h4 class="panel-title">
                      <a role="button" data-toggle="collapse" href="#sidebar-classes" aria-expanded="true" aria-controls="collapseOne">
                        Classes
                      </a>
                    </h4>
                    </div>
                    <div id="sidebar-classes" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="sidebar-classes-heading">
                        <div class="panel-body">
                            <ol>
                                    <li>
                                        <a href="../classes/Alias.html">Alias</a>
                                    </li>
                                    <li>
                                        <a href="../classes/Base.html">Base</a>
                                    </li>
                                    <li>
                                        <a href="../classes/Belongs To.html">Belongs To</a>
                                    </li>
                                    <li>
                                        <a href="../classes/Collection.html">Collection</a>
                                    </li>
                                    <li>
                                        <a href="../classes/Confirmation.html">Confirmation</a>
                                    </li>
                                    <li>
                                        <a href="../classes/Custom.html">Custom</a>
                                    </li>
                                    <li>
                                        <a href="../classes/Date.html">Date</a>
                                    </li>
                                    <li>
                                        <a href="../classes/Dependent.html">Dependent</a>
                                    </li>
                                    <li>
                                        <a href="../classes/DS Error.html">DS Error</a>
                                    </li>
                                    <li>
                                        <a href="../classes/Error.html">Error</a>
                                    </li>
                                    <li>
                                        <a href="../classes/Exclusion.html">Exclusion</a>
                                    </li>
                                    <li>
                                        <a href="../classes/Factory.html">Factory</a>
                                    </li>
                                    <li>
                                        <a href="../classes/Format.html">Format</a>
                                    </li>
                                    <li>
                                        <a href="../classes/Has Many.html">Has Many</a>
                                    </li>
                                    <li>
                                        <a href="../classes/Inclusion.html">Inclusion</a>
                                    </li>
                                    <li>
                                        <a href="../classes/Inline.html">Inline</a>
                                    </li>
                                    <li>
                                        <a href="../classes/Length.html">Length</a>
                                    </li>
                                    <li>
                                        <a href="../classes/Messages.html">Messages</a>
                                    </li>
                                    <li>
                                        <a href="../classes/Number.html">Number</a>
                                    </li>
                                    <li>
                                        <a href="../classes/Presence.html">Presence</a>
                                    </li>
                                    <li>
                                        <a href="../classes/Result.html">Result</a>
                                    </li>
                                    <li>
                                        <a href="../classes/ResultCollection.html">ResultCollection</a>
                                    </li>
                            </ol>
                        </div>
                    </div>
                </li>
            </ol>
            <div class="content-container">
                <div class="apidocs">
                    <div id="docs-main">
                        <div class="content">
<div class="page-header">
    <h1><i class="fa fa-file-code-o" aria-hidden="true"></i>  File</h1>
</div>

<div class="file">
    <pre class="prettyprint linenums">
import { bool } from &#x27;@ember/object/computed&#x27;;
import EmberObject, { set, get, computed } from &#x27;@ember/object&#x27;;
import { isNone } from &#x27;@ember/utils&#x27;;
import { getOwner } from &#x27;@ember/application&#x27;;
import Messages from &#x27;@summit-electric-supply/ember-cp-validations/validators/messages&#x27;;
import Options from &#x27;@summit-electric-supply/ember-cp-validations/-private/options&#x27;;
import lookupValidator from &#x27;@summit-electric-supply/ember-cp-validations/utils/lookup-validator&#x27;;
import {
  unwrapString,
  getValidatableValue,
  mergeOptions,
  isPromise
} from &#x27;@summit-electric-supply/ember-cp-validations/utils/utils&#x27;;

class TestResult {
  constructor(result) {
    this.isValid = result === true;
    this.message = typeof result === &#x27;string&#x27; ? result : null;
  }
}

/**
 * @class Base
 * @module Validators
 */
const Base = EmberObject.extend({
  /**
   * Options passed in to the validator when defined in the model
   * @property options
   * @type {Object}
   */
  options: null,

  /**
   * Default validation options for this specific attribute
   * @property defaultOptions
   * @type {Object}
   */
  defaultOptions: null,

  /**
   * Global validation options for this model
   * @property globalOptions
   * @type {Object}
   */
  globalOptions: null,

  /**
   * Model instance
   * @property model
   * @type {Model}
   */
  model: null,

  /**
   * Attributed name of the model this validator is attached to
   * @property attribute
   * @type {String}
   */
  attribute: null,

  /**
   * Error message object. Populated by validators/messages
   * @property errorMessages
   * @type {Object}
   */
  errorMessages: null,

  /**
   * @property isWarning
   * @type {Boolean}
   */
  isWarning: bool(&#x27;options.isWarning&#x27;).readOnly(),

  /**
   * Validator type
   * @property _type
   * @private
   * @type {String}
   */
  _type: null,

  /**
   * Validators cache used by &#x60;test&#x60; api
   * @property _testValidatorCache
   * @private
   * @type {Object}
   */
  _testValidatorCache: computed(() =&gt; ({})).readOnly(),

  init() {
    this._super(...arguments);
    let globalOptions = get(this, &#x27;globalOptions&#x27;);
    let defaultOptions = get(this, &#x27;defaultOptions&#x27;);
    let options = get(this, &#x27;options&#x27;);
    let owner = getOwner(this);
    let errorMessages;

    if (!isNone(owner)) {
      // Since default error messages are stored in app/validators/messages, we have to look it up via the owner
      errorMessages = owner.factoryFor(&#x27;validator:messages&#x27;);
    }

    // If for some reason, we can&#x27;t find the messages object (i.e. unit tests), use default
    errorMessages = errorMessages || Messages;

    set(
      this,
      &#x27;options&#x27;,
      this.buildOptions(options, defaultOptions, globalOptions)
    );
    set(this, &#x27;errorMessages&#x27;, errorMessages.create());
  },

  /**
   * Build options hook. Merges default options into options object.
   * This method gets called on init and is the ideal place to normalize your options.
   * The [presence validator](https://github.com/offirgolan/ember-cp-validations/blob/master/addon/validators/presence.js) is a good example to checkout
   * @method buildOptions
   * @param  {Object} options
   * @param  {Object} defaultOptions
   * @param  {Object} globalOptions
   * @return {Object}
   */
  buildOptions(options = {}, defaultOptions = {}, globalOptions = {}) {
    let builtOptions = mergeOptions(options, defaultOptions, globalOptions);

    // Overwrite the validator&#x27;s value method if it exists in the options and remove it since
    // there is no need for it to be passed around
    this.value = builtOptions.value || this.value;
    delete builtOptions.value;

    return new Options({
      model: get(this, &#x27;model&#x27;),
      attribute: get(this, &#x27;attribute&#x27;),
      options: builtOptions
    });
  },

  /**
   * Used to retrieve the value to validate.
   * This method gets called right before &#x60;validate&#x60; and the returned value
   * gets passed into the validate method.
   *
   * @method value
   * @param {Object} model
   * @param {String} attribute
   * @return The current value of &#x60;model[attribute]&#x60;
   */
  value(model, attribute) {
    return get(model, attribute);
  },

  /**
   * Wrapper method to &#x60;value&#x60; that passes the necessary parameters
   *
   * @method getValue
   * @private
   * @return {Mixed} value
   */
  getValue() {
    let value = this.value(get(this, &#x27;model&#x27;), get(this, &#x27;attribute&#x27;));
    return getValidatableValue(value);
  },

  /**
   * The validate method is where all of your logic should go.
   * It will get passed in the current value of the attribute this validator is attached to.
   * Within the validator object, you will have access to the following properties:
   * @method validate
   * @param  {Mixed} value        The current value of the attribute
   * @param  {Object} options       The built and processed options
   * @param  {Object} model         The current model being evaluated
   * @param  {String} attribute     The current attribute being evaluated
   * @return
   * One of the following types:
   * - &#x60;Boolean&#x60;:  &#x60;true&#x60; if the current value passed the validation
   * - &#x60;String&#x60;: The error message
   * - &#x60;Promise&#x60;: A promise that will either resolve or reject, and will finally return either &#x60;true&#x60; or the final error message string.
   */
  validate() {
    return true;
  },

  /**
   * Used by all pre-defined validators to build an error message that is present
   * in &#x60;validators/message&#x60; or declared in your i18n solution.
   *
   * If we extended our default messages to include &#x60;uniqueUsername: &#x27;{username} already exists&#x27;&#x60;,
   * we can use this method to generate our error message.
   *
   * &#x60;&#x60;&#x60;javascript
   * validate(value, options) {
   *   const exists = false;
   *
   *   // check with server if username exists...
   *
   *   if(exists) {
   *     // The username key on the options object will be used to create the error message
   *     options.username = value;
   *     return this.createErrorMessage(&#x27;uniqueUsername&#x27;, value, options);
   *   }
   *
   *   return true;
   * }
   * &#x60;&#x60;&#x60;
   *
   * If we input &#x60;johndoe&#x60; and that username already exists, the returned message would be &#x60;&#x27;johndoe already exists&#x27;&#x60;.
   *
   * @method createErrorMessage
   * @param  {String} type        The type of message template to use
   * @param  {Mixed} value        Current value being evaluated
   * @param  {Object} options     Validator built and processed options (used as the message string context)
   * @return {String}             The generated message
   */
  createErrorMessage(type, value, options = {}) {
    let messages = this.get(&#x27;errorMessages&#x27;);
    let message = unwrapString(get(options, &#x27;message&#x27;));

    set(
      options,
      &#x27;description&#x27;,
      messages.getDescriptionFor(get(this, &#x27;attribute&#x27;), options)
    );

    if (message) {
      if (typeof message === &#x27;string&#x27;) {
        message = messages.formatMessage(message, options);
      } else if (typeof message === &#x27;function&#x27;) {
        message = message.apply(this, arguments);
        message = isNone(message)
          ? messages.getMessageFor(type, options)
          : messages.formatMessage(message, options);
      }
    } else {
      message = messages.getMessageFor(type, options);
    }

    return message.trim();
  },

  /**
   * Easily compose complicated validations by using this method to validate
   * against other validators.
   *
   * &#x60;&#x60;&#x60;javascript
   * validate(value, options, ...args) {
   *   let result = this.test(&#x27;presence&#x27;, value, { presence: true }, ...args);
   *
   *   if (!result.isValid) {
   *     return result.message;
   *   }
   *
   *   // You can even test against your own custom validators
   *   result = this.test(&#x27;my-validator&#x27;, value, { foo: &#x27;bar&#x27; }, ...args);
   *
   *   if (!result.isValid) {
   *     return result.message;
   *   }
   *
   *   result = this.test(&#x27;number&#x27;, value, { integer: true }, ...args);
   *
   *   // You can easily override the error message by returning your own.
   *   if (!result.isValid) {
   *      return &#x27;This value must be an integer!&#x27;;
   *    }
   *
   *   // Add custom logic...
   *
   *   return true;
   * }
   * &#x60;&#x60;&#x60;
   * @method test
   * @param  {String} type    The validator type (e.x. &#x27;presence&#x27;, &#x27;length&#x27;, etc.)
   *                          The following types are unsupported:
   *                            &#x27;alias&#x27;, &#x27;belongs-to&#x27;, &#x27;dependent&#x27;, &#x27;has-many&#x27;
   * @param  {...args} args   The arguments to pass through to the validator
   * @return {Object}         The test result object which will contain &#x60;isValid&#x60;
   *                          and &#x60;message&#x60;. If the validator is async, then the
   *                          return value will be a promise.
   */
  test(type, ...args) {
    const cache = this.get(&#x27;_testValidatorCache&#x27;);
    const unsupportedTypes = [&#x27;alias&#x27;, &#x27;belongs-to&#x27;, &#x27;dependent&#x27;, &#x27;has-many&#x27;];

    if (unsupportedTypes.includes(type)) {
      throw new Error(
        &#x60;[ember-cp-validations] The \&#x60;test\&#x60; API does not support validators of type: ${type}.&#x60;
      );
    }

    cache[type] = cache[type] || lookupValidator(getOwner(this), type).create();
    const result = cache[type].validate(...args);

    if (isPromise(result)) {
      return result.then(r =&gt; new TestResult(r), r =&gt; new TestResult(r));
    }

    return new TestResult(result);
  }
});

Base.reopenClass({
  /**
   * Generate the needed dependent keys for this validator
   *
   * @method getDependentsFor
   * @static
   * @param  {String} attribute
   * @param  {Object} options
   * @return {Array} dependent keys
   */
  getDependentsFor() {
    return [];
  }
});

export default Base;

/**
 * Creating custom validators is very simple. To generate a validator named &#x60;unique-username&#x60; in Ember CLI
 *
 * &#x60;&#x60;&#x60;bash
 * ember generate validator unique-username
 * &#x60;&#x60;&#x60;
 *
 * This will create the following files
 *
 * * &#x60;app/validators/unique-username.js&#x60;
 * * &#x60;tests/unit/validators/unique-username-test.js&#x60;
 *
 * &#x60;&#x60;&#x60;javascript
 * // app/validators/unique-username.js
 *
 * import BaseValidator from &#x27;@summit-electric-supply/ember-cp-validations/validators/base&#x27;;
 *
 * const UniqueUsername = BaseValidator.extend({
 *   validate(value, options, model, attribute) {
 *     return true;
 *   }
 * });
 *
 * UniqueUsername.reopenClass({
 *   getDependentsFor(attribute, options) {
 *     return [];
 *   }
 * });
 *
 * export default UniqueUsername;
 * &#x60;&#x60;&#x60;
 *
 * **Side Note**: Before we continue, I would suggest checking out the documentation for the {{#crossLink &#x27;Base&#x27;}}Base Validator{{/crossLink}}.
 *
 * If you want to interact with the &#x60;store&#x60; within your validator, you can simply inject the service like you would a component.
 * Since you have access to your model and the current value, you should be able to send the server the right information to determine if this username is unique.
 *
 * &#x60;&#x60;&#x60;javascript
 * // app/validators/unique-username.js
 *
 * import Ember from &#x27;ember&#x27;;
 * import BaseValidator from &#x27;@summit-electric-supply/ember-cp-validations/validators/base&#x27;;
 *
 * const UniqueUsername = BaseValidator.extend({
 *   store: Ember.inject.service(),
 *
 *   validate(value, options, model, attribute) {
 *     return this.get(&#x27;store&#x27;).findRecord(&#x27;user&#x27;, value).then((user) =&gt; {
 *       if(user &amp;&amp; user.id === value) {
 *         let message = &#x60;The username &#x27;${value}&#x27; already exists.&#x60;;
 *         let meta = user.get(&#x27;meta&#x27;);
 *
 *         if(options.showSuggestions &amp;&amp; meta &amp;&amp; meta.suggestions) {
 *           message += &quot;What about one of the these: &quot; + meta.suggestions.join(&#x27;, &#x27;);
 *         }
 *         return message;
 *       } else {
 *         return true;
 *       }
 *     })
 *   }
 * });
 * &#x60;&#x60;&#x60;
 *
 * ## Dependent Keys
 *
 * There will be times when your validator will be dependent on some other property or object. Instead of having to
 * include them in your option&#x27;s &#x60;dependentKeys&#x60;, you can declare them in the static &#x60;getDependentsFor&#x60; hook. This hook
 * receives two parameters. The first is the &#x60;attribute&#x60; that this validator is being added to, and the second are the &#x60;options&#x60;
 * there were passed to this validator.
 *
 * From the above code sample:
 *
 * &#x60;&#x60;&#x60;javascript
 * // app/validators/unique-username.js
 *
 * import BaseValidator from &#x27;@summit-electric-supply/ember-cp-validations/validators/base&#x27;;
 *
 * const UniqueUsername = BaseValidator.extend({});
 *
 * UniqueUsername.reopenClass({
 *   getDependentsFor(attribute, options) {
 *     return [];
 *   }
 * });
 *
 * export default UniqueUsername;
 * &#x60;&#x60;&#x60;
 *
 * All dependent keys are in reference to the model&#x27;s &#x60;validations.attrs&#x60; object. So when you return &#x60;[&#x27;username&#x27;]&#x60;,
 * it will add a dependent to &#x60;model.validations.attrs.username&#x60;. If you want to add a dependent on the model, your
 * key needs to be prefixed with &#x60;model&#x60;. So when you return &#x60;[&#x27;model.username&#x27;]&#x60;, it will add a dependent to &#x60;model.username&#x60; instead of &#x60;model.validations.attrs.username&#x60;.
 * This means that if you have a dependent on a service, that service must be injected into the model since returning &#x60;[&#x27;model.myService.someProperty&#x27;]&#x60;
 * will be interpreted as &#x60;model.myService.someProperty&#x60;.
 *
 * ## Usage
 *
 * To use our unique-username validator we just have to add it to the model definition
 *
 * &#x60;&#x60;&#x60;javascript
 * const Validations = buildValidations({
 *   username: validator(&#x27;unique-username&#x27;, {
 *     showSuggestions: true
 *   }),
 * });
 *
 * export default DS.Model.extend(Validations, {
 *   &#x27;username&#x27;: DS.attr(&#x27;string&#x27;),
 * });
 * &#x60;&#x60;&#x60;
 *
 * ## Testing
 * As mentioned before, the generator created a unit test for your new custom validator.
 *
 * &#x60;&#x60;&#x60;javascript
 * // tests/unit/validators/unique-username-test.js
 *
 * import Ember from &#x27;ember&#x27;;
 * import { moduleFor, test } from &#x27;ember-qunit&#x27;;
 *
 * moduleFor(&#x27;validator:unique-username&#x27;, &#x27;Unit | Validator | unique-username&#x27;, {
 *     needs: [&#x27;validator:messages&#x27;]
 * });
 *
 * test(&#x27;it works&#x27;, function(assert) {
 *     const validator =  this.subject();
 *     assert.ok(validator);
 * });
 * &#x60;&#x60;&#x60;
 *
 * A simple test for our validation method can be as such
 *
 * &#x60;&#x60;&#x60;javascript
 * test(&#x27;username is unique&#x27;, function(assert) {
 *     assert.expect(1);
 *
 *     let validator =  this.subject();
 *     let done = assert.async();
 *
 *     validator.validate(&#x27;johndoe42&#x27;).then((message) =&gt; {
 *       assert.equal(message, true);
 *       done();
 *     });
 * });
 * &#x60;&#x60;&#x60;
 *  @class Custom
 *  @module Validators
 *  @extends Base
 */

    </pre>
</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="../assets/vendor/prettify/prettify-min.js"></script>
    <script>prettyPrint();</script>
    <script src="../assets/vendor/jquery/jquery.min.js"></script>
    <script src="../assets/vendor/jquery-ui/jquery-ui.min.js"></script>
    <script src="../assets/vendor/bootstrap/js/bootstrap.js"></script>
    <script src="../assets/vendor/github-slugger/slugger.js"></script>
    <script src="../assets/js/yuidoc-bootstrap.js"></script>
</body>
</html>
